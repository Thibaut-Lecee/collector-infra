version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:alpine3.23}
    container_name: collector-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - collector-network

  # Fastify API
  api:
    build:
      context: ../collector-api
      dockerfile: Dockerfile
    container_name: collector-api
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      PORT: 5005
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      ZITADEL_ISSUER: ${ZITADEL_ISSUER:-http://localhost:8080}
      ZITADEL_CLIENT_ID: ${ZITADEL_CLIENT_ID}
      ZITADEL_CLIENT_SECRET: ${ZITADEL_CLIENT_SECRET}
      GRAFANA_URL: http://grafana:3000
      ADMIN_ROLE_NAME: ${ADMIN_ROLE_NAME:-admin}
    ports:
      - "5005:5005"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      # Mount logs directory for Promtail to collect
      - api_logs:/app/logs
    networks:
      - collector-network
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:5005/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=api"

  # Loki - Log aggregation
  loki:
    image: grafana/loki:latest
    container_name: collector-loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./docker/loki/loki-config.yaml:/etc/loki/local-config.yaml
      - loki_data:/loki
    networks:
      - collector-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Promtail - Log shipper
  promtail:
    image: grafana/promtail:latest
    container_name: collector-promtail
    volumes:
      - ./docker/promtail/promtail-config.yaml:/etc/promtail/config.yaml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - api_logs:/app/logs:ro
    command: -config.file=/etc/promtail/config.yaml
    depends_on:
      - loki
    networks:
      - collector-network

  # Grafana - Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: collector-grafana
    # NO PUBLIC PORT - Only accessible through API proxy
    # ports:
    #   - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:5005/internal/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - ./docker/grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./docker/grafana/provisioning:/etc/grafana/provisioning
      - grafana_data:/var/lib/grafana
    depends_on:
      loki:
        condition: service_healthy
    networks:
      - collector-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    name: ${POSTGRES_VOLUME:-collector_postgres_data}
  loki_data:
  grafana_data:
  api_logs:

networks:
  collector-network:
    name: collector-network
    driver: bridge
