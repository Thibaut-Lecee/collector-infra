services:
  # -----------------------
  # PostgreSQL (Main DB)
  # -----------------------
  db:
    image: postgres:17
    restart: unless-stopped
    environment:
      PGUSER: ${POSTGRES_USER:-collector}
      POSTGRES_USER: ${POSTGRES_USER:-collector}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change-me}
      POSTGRES_DB: ${POSTGRES_DB:-collector}
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-collector} -d ${POSTGRES_DB:-collector}"]
      interval: 10s
      timeout: 5s
      retries: 5

  db-zitadel:
    image: postgres:17-alpine
    container_name: zitadel-db
    environment:
      POSTGRES_USER: ${ZITADEL_DB_ADMIN_USER:-postgres}
      POSTGRES_PASSWORD: ${ZITADEL_DB_ADMIN_PASSWORD:-change-me}
      POSTGRES_DB: ${ZITADEL_DB_NAME:-zitadel}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${ZITADEL_DB_ADMIN_USER:-postgres} -d ${ZITADEL_DB_NAME:-zitadel}",
        ]
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - dbdata:/var/lib/postgresql/data
    restart: unless-stopped

  # Serves the ZITADEL API and proxies /ui/* to the login frontend
  zitadel:
    image: ghcr.io/zitadel/zitadel:latest
    container_name: zitadel
    depends_on:
      db-zitadel:
        condition: service_healthy
    environment:
      # Database connection (required)
      ZITADEL_DATABASE_POSTGRES_HOST: db-zitadel
      ZITADEL_DATABASE_POSTGRES_PORT: "5432"
      ZITADEL_DATABASE_POSTGRES_DATABASE: ${ZITADEL_DB_NAME:-zitadel}
      ZITADEL_DATABASE_POSTGRES_SSL_MODE: disable
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: ${ZITADEL_DB_ADMIN_USER:-postgres}
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: ${ZITADEL_DB_ADMIN_PASSWORD:-change-me}
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: ${ZITADEL_DB_APP_USER:-zitadel}
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: ${ZITADEL_DB_APP_PASSWORD:-change-me}

      # External domain (required for localhost access)
      ZITADEL_EXTERNALDOMAIN: ${ZITADEL_EXTERNALDOMAIN:-localhost}
      ZITADEL_EXTERNALPORT: 8080
      ZITADEL_EXTERNALSECURE: "false"

      # First instance admin user (required) (username:zitadel-admin@zitadel.localhost)
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: ${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME:-zitadel-admin}
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: ${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD}

      # Disable Login V2 (required - V2 doesn't work properly yet)
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED: "false"
    command: ["start-from-init", "--masterkey", "${ZITADEL_MASTERKEY}", "--tlsMode", "disabled"]
    ports:
      - "8080:8080" # http://localhost:8080
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/debug/healthz"]
      interval: 5s
      timeout: 3s
      retries: 60
    restart: unless-stopped

  # -----------------------
  # API (Fastify)
  # -----------------------
  api:
    image: node:24-alpine
    working_dir: /app
    command: sh -c "npm install --ignore-scripts && npx prisma generate && npx tsx watch src/server"
    env_file:
      - ../collector-api/.env
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-collector}:${POSTGRES_PASSWORD:-change-me}@db:5432/${POSTGRES_DB:-collector}
      - HOST=0.0.0.0
      - PORT=3001
      - GRAFANA_URL=http://grafana:3000
      - ADMIN_ROLE_NAME=admin
      # Zitadel config (Network override)
      - ZITADEL_ISSUER=${ZITADEL_ISSUER:-http://localhost:8080}
      - ZITADEL_INTERNAL_ISSUER=${ZITADEL_INTERNAL_ISSUER:-http://zitadel:8080}
    volumes:
      - ../collector-api:/app
      - /app/node_modules
    ports:
      - "3001:3001"
    depends_on:
      db:
        condition: service_healthy
      zitadel:
        condition: service_started

  # -----------------------
  # Frontend (Next.js)
  # -----------------------
  frontend:
    image: node:24-alpine
    working_dir: /app
    command: sh -c "npm install --ignore-scripts && npm run dev"
    env_file:
      - ../collector-front/.env.local
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3001/api
      - INTERNAL_API_URL=http://api:3001
      - NEXTAUTH_URL=http://localhost:3000
      # Public issuer used by the browser (redirects, URLs in the auth flow)
      - ZITADEL_ISSUER=${ZITADEL_ISSUER:-http://localhost:8080}
      # Back-channel issuer used by the container to reach ZITADEL over the Docker network.
      # ZITADEL selects the instance by Host header (configured as localhost), so the app
      # must send Host=localhost:8080 while calling http://zitadel:8080 internally.
      - ZITADEL_INTERNAL_ISSUER=${ZITADEL_INTERNAL_ISSUER:-http://zitadel:8080}
    volumes:
      - ../collector-front:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_started

  # -----------------------
  # Observability Stack
  # -----------------------
  loki:
    image: grafana/loki:3.0.0
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "3100:3100"
    volumes:
      - ./docker/loki/loki-config.yaml:/etc/loki/local-config.yaml
      - loki-data:/loki

  promtail:
    image: grafana/promtail:3.0.0
    command: -config.file=/etc/promtail/config.yaml
    volumes:
      - ./docker/promtail/promtail-config.yaml:/etc/promtail/config.yaml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - loki

  prometheus:
    image: prom/prometheus:latest
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.enable-lifecycle
      - --web.enable-remote-write-receiver
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    depends_on:
      - api

  k6:
    profiles: ["tools"]
    image: grafana/k6:latest
    entrypoint: ["k6"]
    environment:
      - BASE_URL=http://api:3001
      - K6_PROMETHEUS_RW_SERVER_URL=http://prometheus:9090/api/v1/write
    volumes:
      - ./docker/k6/scripts:/scripts:ro
    depends_on:
      - api

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3002:3000"
    volumes:
      - ./docker/grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./docker/grafana/provisioning:/etc/grafana/provisioning
      - ./docker/grafana/dashboards:/etc/grafana/dashboards
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_SERVER_ROOT_URL=http://localhost:3002/
      - GF_SERVER_SERVE_FROM_SUB_PATH=false
    depends_on:
      - loki

volumes:
  db-data:
  dbdata:
  loki-data:
  prometheus-data:
  grafana-data:
